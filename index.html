<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DECRYPT</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.34.2/es6-shim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	<script>
	window.onerror = function(msg, url, line, col, error) {
		var message = "Error: " + msg + "\nUrl: " + url + "\nLine: " + line + (!col ? '' : '\nColumn: ' + col) + (!error ? '' : '\nError: ' + error);
		document.getElementById('log-box').style.display = 'block';
        if (typeof message == 'object') {
            document.getElementById('log').innerHTML += (JSON && JSON.stringify ? JSON.stringify(message) : message) + "\n";
        } else {
            document.getElementById('log').innerHTML += message + "\n";
        }
			window.scrollTo(0,0);
	};
	</script>
  </head>
  <body>
  	<div class="alert alert-danger collapse" id="log-box">
	<p><strong><span class="glyphicon glyphicon-alert"></span></strong></p>
	<pre id="log"></pre>
	</div>
	
  	<div class="alert alert-information collapse" id="status-box">
	<p>
		<strong><span class="glyphicon glyphicon-pencil spin"></span></strong>
		<span id="status"></span>
	</p>
	</div>

	<script src="code.js"></script>
	<script src="word.js"></script>
	<script src="solution.js"></script>
	<script src="constants.js"></script>
	<script src="10k.js"></script>
    <script>
		function log(obj, cls, handler, args) {
			if(typeof obj == 'object')
				obj = JSON.stringify(obj);
			
			var li = $('<li></li>')
				.append($('<pre></pre>')
					.addClass(cls ? 'text-' + cls : '')
					.text(obj));
			
			$("#plog").append(li);
						
			//window.scrollTo(0,document.body.scrollHeight);
			if(typeof handler == 'function')
				handler(args, li);
		}
		function status(message) {
			if(!message || message === false || message == '')
				return $('#status-box').hide();
			
			$('#status-box').show();
			$('#status').text(message);
		}
		
		var old = [
			'OG ZOVJ DVKNWNVM SNOY OYQ FQZO EMVUONUQZ, MQVX OYQ VWSVJZZQULMQ BQSZWQOOQMZ!',
			'LPK BHJQKSPDQ? NPQK KOJC UK KOJ UMEUIQPD UMEUIQQJAHGJ XPGHC!',
			'ERJL OTC UYOCGO RJEPFDYORPJ EFPD YUIYZGGCMXFC NZ XGRJV OTC YUIYZGMPJJCMOCL DPNRUC YHH!',
			'JVX CTJVXQLICVT VT PVR IV HXVIDMI EVFX LHHA, ADD KV/ADMFXDQEMVWD!',
			'TPZ K PAINJM, TJFDTZ QKPPCNIX KJX QFJ BNI ZKVG NB LNTI KVVNTJAP!',
			'JHIIHR EWREW TE XHYG DWEC QWPWREW â€“ TP EHIWCBTRM EWWIE EYEKTJTHYE, HQQ HG CHH MHHQ CH DW CGYW, TC TE IHEC VTFWVX UR UCCUJF!',
		];
		
		function getFrequencyMatches(code, mode, motive)
		{
			var solution = new Solution([], code, [motive]);
			var freq = [];
			for(var i=0; i<Constants.alphabet.length; i++)
				freq.push({ letter: Constants.alphabet[i], frequency: 0 });
			
			var frequencies;
			
			switch(mode) {
				case "firstLetter":
					frequencies = Constants.byWordStartFrequency;
					code.words.forEach(function(w) {
						var f = freq.find(function(x) { return x.letter == w.word[0]; });
						if(f) f.frequency++;
					});
					break;
				case "letter":
					frequencies = Constants.byLetterFrequency;
					code.code.split('').forEach(function(l) {
						var f = freq.find(function(x) { return x.letter == l; });
						if(f) f.frequency++;
					});
					break;
				default:
					throw "getFrequencyMatches: Invalid mode: '" + mode + "'";
			}
	
	
			freq.sort(function(a,b) { return b.frequency - a.frequency; });
			freq = freq.filter(function(x) { return x.frequency > 0; });
			//log(solution.solve());
			
			var m = 0, i = 0;
			
			while(m < freq.length && i < frequencies.length) {
				if(solution.matches.some(function(w) { return w.letter == frequencies[i]; })) {
					i++;
					continue;
				}
				if(solution.matches.some(function(w) { return w.code == freq[m].letter; })) {
					m++;
					continue;
				}
				
				solution.setLetter(
					freq[m++].letter, 
					frequencies[i++]);
			}
			
			solution.fill();
			return solution;
		}
		
		function initialize() {
			$("#enter").hide();
			$("#solve").show();
			var code = new Code( $('#code-input').val().trim() );
			$("#code").text(code.code);
			
			var abc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			
			var solutions = [];
			// create 10 parent solutions
			for(var i=0; i<10; i++) {
				var chance = Math.random();
				var solution;
				
				if(chance > .6) {
					solution = getFrequencyMatches(code, "letter", "Birth Schema: Letter Frequency");
				} else if(chance > .3) {
					solution = getFrequencyMatches(code, "firstLetter", "Birth Schema: First Letter Freqency");
				} else {
					solution = new Solution([], code, ["Birth Schema: Random Letters"]);
				}
				var j=0;
				var found = false;
				while(j++ < 10 && found === false) { 
					found = solution.wordHunt();
				};
				solution.fill();
				log(solution.solve());
				solutions.push(solution);
			}
			return solutions;
			
			/*
			var solution = new Solution([], code);
			
			var freq = [];
			for(var i=0; i<abc.length; i++)
				freq.push({ letter: abc[i], frequency: 0 });
			
			code.words.forEach(function(w) {
				var f = freq.find(function(x) { return x.letter == w.word[0]; });
				f.frequency++;
			});
			freq.sort(function(a,b) { return b.frequency - a.frequency; });
			freq = freq.filter(function(x) { return x.frequency > 0; });
			
			//log(solution.solve());
			
			var m = 0, i = 0;
			
			while(m < freq.length && i < Constants.byWordStartFrequency.length) {
				if(solution.matches.some(function(w) { return w.letter == Constants.byWordStartFrequency[i]; })) {
					i++;
					continue;
				}
				if(solution.matches.some(function(w) { return w.code == freq[m].letter; })) {
					m++;
					continue;
				}
				
				solution.setLetter(
					freq[m++].letter, 
					Constants.byWordStartFrequency[i++]);
			}
			
			//log(solution.solve());
			
			//log(matches);
			
			//var solution = new Solution(matches, code);
			solution.fill();
			log(solution.solve());
			return solution;
			*/
		}
		
		function finishGeneration(statics) {
			statics.generation++;
			$('#continue').data('statics', statics);
			
			if(statics.generation <= statics.maxGeneration) {
				var best = statics.ancestors.filter(function(x) { return x.score.score == 1; });
				if(best.length > 0) {
					log(best.length.toString() + " valid solutions discovered", "success");
					best.forEach(function(x) {
						log(x.score.decrypted, "primary", logHandler, x);
						$('#plog').find("li").last().find('a').click();
						log(x.history);
						log(statics.mutations.toString() + " mutations processed");
						//$('#solution').show().append(
						//	$('<p></p>').text(x.score.decrypted)
						//	);
						status(false);
					});
				}
				else
					setTimeout(function() {
						runGeneration(statics);
					}, 100);
			}
			else {
				$('#plog').find("a").last().click();
				log(statics.maxGeneration.toString() + " Generations Complete", "success");
				log(statics.mutations.toString() + " mutations processed");
				status(false);
				$('#solution').show().find("#solution-details").empty().append(
					$('<p></p>').text(statics.ancestors.length.toString() + " solutions available")
						)
					
					.append(
						$('<a href="#"></a>')
							.text('Scroll to Bottom')
							.click(function(e) { e.preventDefault(); window.scroll(0, $(document).height()); })
					);
			}
		}
		
		function runGeneration(statics) {
			//log("------", "primary");
			log("Generation: " + statics.generation.toString(), "primary");
			
			status("Generation: " + statics.generation.toString());

			var newAncestors = [];
			
			setTimeout(function() {
				runAncestors([], 0, statics);
			}, 100);
		}
		
		function finishAncestors(newAncestors, statics) {
			newAncestors.sort(function(a,b) { return b.score.words - a.score.words; });
			
			if(newAncestors.length == 0)
			{
				log("All ancestors were less fit than their parent :(", "warning")
				return finishGeneration(statics);
			}
			
			statics.last = newAncestors[0].score;
			newAncestors.filter(function(c) { return c.score.words >= statics.last.words - 2; });
			if(newAncestors.length > 12)
				newAncestors.length = 12;
			
			statics.ancestors = [];
			for(var i=newAncestors.length - 1;i>=0;i--) {
				statics.ancestors.push(newAncestors.pop(i));
			}
			
			for(var i=statics.ancestors.length - 1, a1; a1=statics.ancestors[i]; i--) {
				for(var j=i-1, a2; a2=statics.ancestors[j];j--) {
					if(a2.equals(a1)) {
						statics.ancestors.splice(i, 1);
						break;
					}
				}
			}

			
			//log("Winners:");
			statics.ancestors.forEach(function(a) {
				log(a.score, null, logHandler, a);
			});
			finishGeneration(statics);
		}
		
		function runAncestors(newAncestors, index, statics) {
			//log(" Ancestor " + index.toString() + ": Reproducing");
			status("Generation " + statics.generation.toString() + ", Ancestor " + index.toString() + ": Reproducing");
			var ancestor = statics.ancestors[index];
			var children = ancestor.reproduce(
				15, // children
				.5, // odds of letter replacement
				.5, // odds of letter switch
				statics.ancestors //mates
				);
			
			children.forEach(function(c) {
				c.solve();
				statics.mutations++;
			});
			
			children = children.filter(function(c) { return c.score.words >= statics.last.words - 2; });
			//children.sort(function(a,b) { return b.score.words - a.score.words; });
			
			children.forEach(function(c) {
				newAncestors.push(c);
			});
			children = null;
			
			index++;
			
			if(index == statics.ancestors.length)
				setTimeout(function() {
					finishAncestors(newAncestors, statics);
				}, 100);
			else
				setTimeout(function() {
					runAncestors(newAncestors, index, statics);
				}, 100);
		}
		
		function logHandler(solution, $li) {
			var s = JSON.parse(JSON.stringify(solution));
			$li.find('pre').prepend(
				$('<a href="#"></a>')
					//.text("Click to render solution")
					.click(function(e) {
						e.preventDefault();
						populateLetters(s);
						window.scroll(0, 0);
					})
					.html('<span class="glyphicon glyphicon-share">&nbsp;</span>')
				);
		}
		
		function populateLetters(solution) {
			$('#head, #body, #out, #history').empty();
			for(var i=0; i<Constants.alphabet.length; i++) {
				var a = Constants.alphabet[i];
				$("#head").append($('<th>' + a + '</th>'));
				
				var match = solution.matches.find(function(x) { return x.code == a; });
				var val = match ? match.letter : '';
				
				var input= $('<input type="text" class="form-control" id="input' + a + '" data-letter="' + a + '" value="' + val + '">');
				
				$("#body").append($('<td></td>').append(input));

				input.change(function(e) {
					var code = $('#code').text();
					var out = '';
	
					if(e && e.target) {
						var letter = $(e.target).data("letter");
					}
					for(var i=0; i<code.length; i++) {
						var a = code[i];
	
						if(Constants.alphabet.indexOf(a.toUpperCase()) < 0)
						{
							out += a.toUpperCase()
							continue;
						}
	
						var x = $('#input' + a).val().toUpperCase();
						if(x == '')
							x = '-';
						out += x;
					}
					$("#out").text(out);
				});
			}
			$('input').first().change();
			$("#history").text(JSON.stringify(solution.history));
		}
	
		$(document).ready(function() {
			var cde = old[Math.floor(Math.random() * old.length)];
			$('#code-input').val(cde);
			$('#code').text(cde);

			//log("Hello world");
			
			$("#enter").show();
			$("#enter-button").click(function(e) {
				var solutions = initialize();
				solutions.sort(function(a,b) { return b.score.words - a.score.words; });
				var last = solutions[0].score;

				var statics = {
					generation: 0,
					maxGeneration: 10,
					ancestors: solutions,
					last: last,
					mutations: 1,
				};
				
				runGeneration(statics);
			});
			$("#continue").click(function(e) {
				e.preventDefault();
				var statics = $(this).data('statics');
				statics.maxGeneration += 10;
				runGeneration(statics);
			});
    	});
    </script>

  	<div class="container">
	    <h1>
    		Decryption
    	</h1>
		
		<div class="collapse" id="enter">
			<p><strong>Enter the latest code</strong></p>
			<p>You can get the latest code at <a href="http://team.usaa.com/sites/it/AlwaysOn/Pages/Newsletter.aspx">http://team.usaa.com/sites/it/AlwaysOn/Pages/Newsletter.aspx</a></p>
			<textarea class="form-control" id="code-input">ERJL OTC UYOCGO RJEPFDYORPJ EFPD YUIYZGGCMXFC NZ XGRJV OTC YUIYZGMPJJCMOCL DPNRUC YHH!</textarea>
			<div class="row">
				<div class="col-md-4 col-md-offset-4">
					<button type="button" class="btn btn-primary btn-lg btn-block" id="enter-button">Begin Solve</button>
				</div>
			</div>
		</div>
		<div id="solution" class="collapse">
			<div id="solution-details"></div>
			<p><a href="#" id="continue">Keep Solving</a></p>
		</div>
		<div class="collapse" id="solve">
			<h3><code id="code"></code></h3>
			<table>
				<tr id="head"></tr>
				<tr id="body"></tr>
			</table>
			<h3><code id="out"></code></h3>
			<pre id="history"></pre>
		</div>
		<hr />
		<h4>Log</h4>
		<ul id="plog"></ul>
   </div>
  </body>
</html>